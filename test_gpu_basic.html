<!DOCTYPE html>
<html>

<head>
    <title>WebGPU Membrane Sandbox</title>
</head>

<body>
    <h1>WebGPU Membrane Force Validation</h1>
    <pre id="log"></pre>
    <script>
        const logger = document.getElementById('log');
        function log(msg) {
            console.log(msg);
            logger.textContent += msg + '\n';
        }

        async function initWebGPU() {
            if (!navigator.gpu) {
                log("WebGPU not supported on this browser.");
                return null;
            }
            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter) {
                log("No appropriate GPUAdapter found.");
                return null;
            }
            const device = await adapter.requestDevice();
            log("WebGPU Initialized: " + adapter.name);
            return device;
        }

        async function runTest() {
            const device = await initWebGPU();
            if (!device) return;

            // Simple WGSL to test compute
            const shaderCode = `
                @group(0) @binding(0) var<storage, read> input: array<f32>;
                @group(0) @binding(1) var<storage, read_write> output: array<f32>;

                @compute @workgroup_size(64)
                fn main(@builtin(global_invocation_id) global_id: vec3<u32>) {
                    let index = global_id.x;
                    if (index >= arrayLength(&input)) { return; }
                    output[index] = input[index] * 2.0;
                }
            `;

            const shaderModule = device.createShaderModule({ code: shaderCode });

            const inputData = new Float32Array([10, 20, 30, 40, 50]);
            const inputBuffer = device.createBuffer({
                size: inputData.byteLength,
                usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_DST,
            });
            device.queue.writeBuffer(inputBuffer, 0, inputData);

            const outputBuffer = device.createBuffer({
                size: inputData.byteLength,
                usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_SRC,
            });

            const bindGroupLayout = device.createBindGroupLayout({
                entries: [
                    { binding: 0, visibility: GPUShaderStage.COMPUTE, buffer: { type: "read-only-storage" } },
                    { binding: 1, visibility: GPUShaderStage.COMPUTE, buffer: { type: "storage" } },
                ],
            });

            const bindGroup = device.createBindGroup({
                layout: bindGroupLayout,
                entries: [
                    { binding: 0, resource: { buffer: inputBuffer } },
                    { binding: 1, resource: { buffer: outputBuffer } },
                ],
            });

            const pipelineLayout = device.createPipelineLayout({ bindGroupLayouts: [bindGroupLayout] });
            const computePipeline = device.createComputePipeline({
                layout: pipelineLayout,
                compute: { module: shaderModule, entryPoint: "main" },
            });

            const commandEncoder = device.createCommandEncoder();
            const passEncoder = commandEncoder.beginComputePass();
            passEncoder.setPipeline(computePipeline);
            passEncoder.setBindGroup(0, bindGroup);
            passEncoder.dispatchWorkgroups(Math.ceil(inputData.length / 64));
            passEncoder.end();

            const stagingBuffer = device.createBuffer({
                size: inputData.byteLength,
                usage: GPUBufferUsage.MAP_READ | GPUBufferUsage.COPY_DST,
            });
            commandEncoder.copyBufferToBuffer(outputBuffer, 0, stagingBuffer, 0, inputData.byteLength);

            device.queue.submit([commandEncoder.finish()]);

            await stagingBuffer.mapAsync(GPUMapMode.READ);
            const result = new Float32Array(stagingBuffer.getMappedRange());
            log("Input: " + inputData);
            log("Result: " + result);
            stagingBuffer.unmap();

            if (result[0] === 20 && result[4] === 100) {
                log("SUCCESS: Basic WebGPU Compute works!");
            } else {
                log("FAILURE: Result unexpected.");
            }
        }

        runTest();
    </script>
</body>

</html>